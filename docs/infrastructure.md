
# 인프라 설계서

---

## 1. 다이어그램

```
┌─────────────────────────────────────────────────┐
│                VPC  (AZ 분산)                    │
│                                                 │
│   ┌──────────────┐   ┌──────────────┐           │
│   │  Public Sub  │   │  Public Sub  │           │
│   │  (AZ-A)      │   │  (AZ-B)      │           │
│   │              │   │              │           │
│   │  API GW      │   └──────────────┘           │
│   └────┬─────────┘           ▲                  │
│        │HTTPS암호화           │                  │
│   ┌────▼───────┐       ┌─────┴──────┐           │
│   │  ALB       │─────▶│  ALB        │(Cross-AZ)│
│   └────┬───────┘       └─────┬──────┘           │
│        │◀──────── Health Check ─────▶│         │
│   ┌────▼─────────┐   ┌────────▼─────┐           │
│   │ EC2 #1       │   │  EC2 #2      │  <-- Auto│
│   │ (Spring Boot)│   │ (Spring Boot)│      Scale│
│   └────┬─────────┘   └────────┬─────┘           │
│        │ JDBC        JDBC     │                  │
│        │ Redis-CLI   Redis-CLI│                  │
│        │ S3-API      S3-API   │                  │
│        │             │        │                  │
│   ┌────▼─────────┐   │   ┌────▼─────┐           │
│   │ RDS          │   │   │ Redis     │           │
│   │ (MySQL)      │   │   │(세션·캐시·락)         │
│   └──────────────┘   │   └──────────┘           │
│                      │                          │
│                      │   ┌──────────────┐       │
│                      └──▶│ S3 (상품이미지 저장용) │
│                          └──────┬───────┘       │
│                                 │ HTTPS         │
│                                 │ (직접 접근)    │
│                                 ▼               │
│                          ┌──────────────┐       │
│                          │ 클라이언트     │       │
│                          │ (직접 접근)    │       │
│                          └──────────────┘       │
│                                                 │
│   ┌──────────────────────────────┐              │
│   │ SQS (OrderCompleted Queue)   │◀────┐        │
│   └──────────────────────────────┘      │       │
│                                         │Event  │
│                              ┌──────────┘       │
│                              │ 외부 데이터 플랫폼 │
│                              └─────────────────┘
└─────────────────────────────────────────────────┘
```

---

## 2. 컴포넌트별 역할

| 계층 | 서비스 | 하는 일 | 왜 필요한가? |
|------|---------|---------|--------------|
| **Entry** | **API Gateway** | TLS 종단, 간단한 라우팅·쿼터 | “정문” – 모든 요청을 한 곳으로 |
| **Entry** | **ALB** | L7 로드밸런싱, 헬스체크 | 서버 2대 이상일 때 필수 |
| **App** | **EC2 Auto-Scaling Group** | Spring Boot 실행 컨테이너 | 트래픽 따라 서버 수 자동 조절 |
| **Cache** | **Redis (ElastiCache)** | 세션, 장바구니, 쿠폰 카운터, 인기상품 캐시 | 메모리 기반이라 DB보다 빠름 |
| **DB** | **RDS (MySQL)** | 모든 영속 데이터 저장 | 트랜잭션 + SQL (MyBatis) |
| **Object** | **S3** | 상품 이미지 파일 저장 | 무제한·저렴·정적 URL 제공 |
| **Async** | **SQS** | 주문 완료 이벤트를 외부 시스템으로 전달 | 비동기로 응답 지연 방지 |

memo - 
ALB(Application Load Balancer)
AWS에서 제공하는 로드 밸런서 서비스로, 다음과 같은 역할을 합니다:
1. 로드 밸런싱: 여러 서버(EC2 인스턴스)에 들어오는 트래픽을 분산시킵니다
2. 헬스 체크: 서버가 정상 작동하는지 주기적으로 확인하고, 문제가 있는 서버는 트래픽에서 제외합니다
3. L7 레벨 라우팅: HTTP/HTTPS 요청의 경로, 헤더, 쿠키 등을 기반으로 요청을 적절한 서버로 라우팅합니다
EC2 인스턴스가 2대 이상 있을 때 (Auto-Scaling) 사용자 요청을 여러 서버에 균등하게 분산시키기 위해
서버 중 하나가 다운되어도 다른 서버로 요청을 전달하여 서비스 중단을 방지하기 위해 사용

S3(Simple Storage Service)
AWS에서 제공하는 객체 저장소(Object Storage) 서비스로, 다음과 같은 특징을 가집니다:
1. 무제한 용량: 원하는 만큼 파일을 저장할 수 있습니다
2. 고가용성: 99.999999999% (11개 9) 내구성을 보장합니다
3. 저렴한 비용: GB당 월 $0.023 (서울 리전 기준)으로 매우 경제적입니다
4. 웹 접근: HTTP/HTTPS URL을 통해 파일에 직접 접근 가능합니다
5. 자동 백업: AWS가 알아서 데이터를 안전하게 보관합니다
상품 이미지와 같은 정적 파일을 저장하기 위해 사용하며, 클라이언트가 직접 접근할 수 있어 서버 부하를 줄입니다
EC2 서버에 저장하는 것보다 비용 효율적이고 확장성이 뛰어납니다

---

## 3. 데이터 흐름 - 주문 1건 예시

1. **POST /orders** → API GW → ALB → EC2(#1).  
2. 서버는 MyBatis를 통해 `SELECT … FOR UPDATE`로 **RDS**에서 재고·잔액 차감.  
3. 성공 시 **SQS**에 `OrderCompleted` 메시지 발행.  
4. 다른 소비자(외부 데이터 플랫폼)가 메시지를 가져가 통계 적재.  
5. 클라이언트에 **200 OK** 응답.  
6. 인기상품 API 호출 시 **Redis** 캐시 조회 → 미스이면 MyBatis로 RDS 집계 테이블 쿼리 후 Redis에 저장(TTL 60s).
7. **상품 이미지 조회**: 클라이언트가 **S3** URL로 직접 접근 → 이미지 제공 (EC2 경유하지 않음).
8. **상품 이미지 등록**: 관리자가 상품 등록 시 EC2에서 **S3**로 이미지 업로드.

---

## 4. 최소 사양 - 첫 달 비용(대략)

| 리소스 | 예시 스펙 | 월비용 |
|--------|-----------|------------------|
// 여긴 어떻게 작성할지 모르겠는데...
---

## 5. 앞으로의 확장 아이디어

---

## 6. 수정사항

### 수정 1 : 서비스 간 연결 관계의 정확한 표현
#### 수정 전 문제점
- 다이어그램에서 `EC2 → RDS → Redis → S3`의 순차적 연결로 표현
- 실제 시스템에서는 각 서비스가 독립적으로 동작함
#### 수정 후 개선사항
- **EC2 → RDS**: JDBC 연결 (데이터베이스 접근)
- **EC2 → Redis**: Redis-CLI 연결 (캐시/세션 관리)  
- **EC2 → S3**: S3-API 연결 (파일 저장/조회)
#### 기술적 장점
- **독립적 서비스**: RDS, Redis, S3가 각각 독립적인 역할 수행
- **중앙 집중식 연결**: EC2 애플리케이션이 모든 서비스와 직접 통신
- **명확한 책임 분리**: 각 서비스의 역할이 다이어그램에서 명확히 구분됨


### 수정 2 :  S3 상품 이미지의 클라이언트 직접 접근
- 상품 이미지는 정적 리소스로 EC2를 경유할 필요가 없음
- 클라이언트에서 직접 접근하여 성능 향상 및 서버 부하 감소
#### 수정 후 개선사항
- **이미지 업로드**: 관리자 → EC2 → S3 (기존과 동일)
- **이미지 조회**: 클라이언트 → S3 (직접 접근)
#### 기술적 장점
- **성능 개선**: EC2 서버 리소스 절약 및 응답 속도 향상
- **비용 효율성**: CDN 없이 S3만 사용하여 비용 절약

---
