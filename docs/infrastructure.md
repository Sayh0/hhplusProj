
# 인프라 설계서

---

## 1. 다이어그램

```
┌─────────────────────────────────────────────────┐
│                VPC  (AZ 분산)                    │
│                                                 │
│   ┌──────────────┐   ┌──────────────┐           │
│   │  Public Sub  │   │  Public Sub  │           │
│   │  (AZ-A)      │   │  (AZ-B)      │           │
│   │              │   │              │           │
│   │  API GW      │   └──────────────┘           │
│   └────┬─────────┘           ▲                  │
│        │HTTPS암호화           │                  │
│   ┌────▼───────┐       ┌─────┴──────┐           │
│   │  ALB       │─────▶│  ALB        │(Cross-AZ)│
│   └────┬───────┘       └─────┬──────┘           │
│        │◀──────── Health Check ─────▶│         │
│   ┌────▼─────────┐   ┌────────▼─────┐           │
│   │ EC2 #1       │   │  EC2 #2      │  <-- Auto│
│   │ (Spring Boot)│   │ (Spring Boot)│      Scale│
│   └────┬─────────┘   └────────┬─────┘           │
│        │ JDBC                │                  │
│   ┌────▼─────────┐           │                  │
│   │ RDS          │ <───► Read Replica (선택사항) │
│   │ (MySQL)      │                              │
│   └────┬─────────┘                              │
│        │ Redis-CLI                              │
│   ┌────▼─────────┐                              │
│   │ Redis        │  (세션·캐시·락)              │
│   └────┬─────────┘                              │
│        │ S3-API                                │
│   ┌────▼─────────┐                              │
│   │ S3 (상품이미지 저장용)                         │
│   └──────────────┘                              │
│                                                 │
│   ┌──────────────────────────────┐              │
│   │ SQS (OrderCompleted Queue)   │◀────┐        │
│   └──────────────────────────────┘      │       │
│                                         │Event  │
│                              ┌──────────┘       │
│                              │ 외부 데이터 플랫폼 │
│                              └─────────────────┘
└─────────────────────────────────────────────────┘
```

---

## 2. 컴포넌트별 역할

| 계층 | 서비스 | 하는 일 | 왜 필요한가? |
|------|---------|---------|--------------|
| **Entry** | **API Gateway** | TLS 종단, 간단한 라우팅·쿼터 | “정문” – 모든 요청을 한 곳으로 |
| **Entry** | **ALB** | L7 로드밸런싱, 헬스체크 | 서버 2대 이상일 때 필수 |
| **App** | **EC2 Auto-Scaling Group** | Spring Boot 실행 컨테이너 | 트래픽 따라 서버 수 자동 조절 |
| **Cache** | **Redis (ElastiCache)** | 세션, 장바구니, 쿠폰 카운터, 인기상품 캐시 | 메모리 기반이라 DB보다 빠름 |
| **DB** | **RDS (MySQL)** | 모든 영속 데이터 저장 | 트랜잭션 + SQL (MyBatis) |
| **Object** | **S3** | 상품 이미지 파일 저장 | 무제한·저렴·정적 URL 제공 |
| **Async** | **SQS** | 주문 완료 이벤트를 외부 시스템으로 전달 | 비동기로 응답 지연 방지 |

memo - 
ALB(Application Load Balancer)
AWS에서 제공하는 로드 밸런서 서비스로, 다음과 같은 역할을 합니다:
1. 로드 밸런싱: 여러 서버(EC2 인스턴스)에 들어오는 트래픽을 분산시킵니다
2. 헬스 체크: 서버가 정상 작동하는지 주기적으로 확인하고, 문제가 있는 서버는 트래픽에서 제외합니다
3. L7 레벨 라우팅: HTTP/HTTPS 요청의 경로, 헤더, 쿠키 등을 기반으로 요청을 적절한 서버로 라우팅합니다
EC2 인스턴스가 2대 이상 있을 때 (Auto-Scaling) 사용자 요청을 여러 서버에 균등하게 분산시키기 위해
서버 중 하나가 다운되어도 다른 서버로 요청을 전달하여 서비스 중단을 방지하기 위해 사용

---

## 3. 데이터 흐름 - 주문 1건 예시

1. **POST /orders** → API GW → ALB → EC2(#1).  
2. 서버는 MyBatis를 통해 `SELECT … FOR UPDATE`로 **RDS**에서 재고·잔액 차감.  
3. 성공 시 **SQS**에 `OrderCompleted` 메시지 발행.  
4. 다른 소비자(외부 데이터 플랫폼)가 메시지를 가져가 통계 적재.  
5. 클라이언트에 **200 OK** 응답.  
6. 인기상품 API 호출 시 **Redis** 캐시 조회 → 미스이면 MyBatis로 RDS 집계 테이블 쿼리 후 Redis에 저장(TTL 60s).

---

## 4. 최소 사양 - 첫 달 비용(대략)

| 리소스 | 예시 스펙 | 월비용 |
|--------|-----------|------------------|
// 여긴 어떻게 작성할지 모르겠는데...
---

## 5. 앞으로의 확장 아이디어

---
